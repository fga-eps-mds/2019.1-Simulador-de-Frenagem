sudo: required

language: minimal

services:
  - docker

notifications:
  slack:
    secure: pP5E+YX1+qR3chyZmyBwt/00wZ2HL4ENjFBSxqLbf/0rOjr+SBwf/IwQbFCEqdWkAGxccD71uegZ0q7Kgs4nCNqItCyau/2S61QWBOvGUJtdhsnSZQ7sQjLOKBUUgeQlZGC7xDandxRV6XgVegUu6/l28xttxTkNcE1Q3i/0WoAXUcmOyH32Flw454WxIlSMgOX0xb1Npj+15F+sKoo3od26/Nd7UyHnGQD3fO0Kk5DHLMs2Kr8x1UFI7+nIrQmI4FVGcVEnOMa+mKI0LlhvAi7Ma6C8l+BQJTAwPG3HqamCrq7l7cyWmDpQY3ySjPSfp2f1LzPBLx3Bx54wb0YQiLt0nQlW/oymlXDH+8q53KEIyXm72yOTvWZR5bldmjf5Ap7OEAWLbSZRMEleZCcKrZ6q8zJn+IRuSqT0VJQUS89IjTlG9MKznipD0qBmI9N5QbPl8wk502po+5U3oYuptGV+JOSC2aC6RcJqWtgKaElHFJMfAqm80VDzuW9+9f7llIsLEpwbKCj3xpysHZQOYVT0zwo2gP/15kGr445xbGOaYhJ7rEnTXhixgyRD+SeXmJkzTLX6HY1HlPaNLNy3ggcbg+4yEr/t4lN61RVGK+hfsO0DwSta++rLC8xj/prfI91BPS4ttCB8/5R5f5plN15sRgkyZ9zboUAxv0ERWyE=

cache:
  directories:
    - "unbrake-frontend/node_modules"

env:
  global:
    - DOCKER_COMPOSE_VERSION=1.23.2

    # code climate test reporter id (it's not so secret)
    - secure: "CFCx6LcmtNOBVyFjxgW8NcrmAs3Fr7ueq4tbjg8f7LCHRodsQMxAAL8+8BbeP41YDZ34mqEwemc8QG5dXXSE8lFVAzJfUUQnYncpu1YiywwYmxP6cNWcBtu1h6sBUOfObBz2mQyJnt1yL2TKob4vaK0jtzy099Mew8aIxRzqcHL04TqxG902ITdGiraH89nIN64MKw7CQMUy65S0kRo1RJkQQDJ9s5CKVnBy3n0Vv8qJj+JqKrzJeRSOrpxElg0yOEe7hFNQkavyBbyGt++f0O1AupQxP9drCxrWRsYTUt/+WNWiZnkNXWSBqHgwrYn13ObthrmgHw5vNTA8sYnzav68kypRbuQm4b4oUaSuQWa5c6cfl0wKa7Uk5t8np78wVByK9+yy84+KL91kDYrxFVEoWe55CDDvL1G6HWP28x1cmL8GA35H+rADDdXQaxxEeDpbExTwOf7N3brNfUh416psDF9VyVqDq46wtJapuAE3Onj9rWmP+EMYxaBdVeV+2wi24/sowwqPQF+sBHWnW0pM+xmOztrptZRdMnwCuVzWt+ROVWm+/tAVn5k+Q1/KW9IXF3JF3975A14Bj+x5HxbbHAs95TOcD79qsAO0L+FMHxadgrMcEFwSPP9sTEfwagKLoX7jnXwOQq9hFwkUxGHDDH4Tj7y7OEM/JXo+JJw="

    # docker user
    - secure: "JjYzX/71jkBYS7NcfrXQuvNyyUepw/5ZFfKdYi7bnF6s6bDxoKGv8SFSoczToOfwaynQWc5mnG5s5BZO8rQJCN5i8dgKvoLEkRF3wzXZMa7nNAZrZW0pc/4kkRy13PZyc/ZV3MTtO5ccwLeErQ1gLDb+UixtBxDxZ7N/+lseylTO149BgiT48anc7U1rmzI8XJiMzareajJzuHssVyZTZfkxj34eHTXIAp+8mTJGL3vWA8/0bvcl0kLWQDIoGeX8qqM6CSfiK0mRj+mVqn9l8FXVgQayZQU8/HJg+5KhAbiPbtyQ+0CZWYrj2UiqV7T6IckI23NAsvG9TISr9q77fzgNLgEL7yEwVzSntcGjeD5bq8aODrMSlLxbqZPykptZtv/NuXDbtH4pASQe14mjTNtvYGk9E1yIKH4WfmKKMU1GePclb5bN3J+j33lWqpLGOhHnAgJtpkoJ1UREu1ves6TP5ELdaDXx9dBNQh/IrUBQwYcjj5qhxr6iA2wzei7jWJv3RcN1s7m80kSHRcaTSQZkuNUaXhNbtZYXO/aVu3y2KspRByu9gITnmG0Dib5Ed2nx8QYKWZppb3SHCz14jWAFRiSua7pkCJ/QheJLAIFIPTuDCAOHpC7Y7+AUuGYfn2CUJkajoXg9dAb9tKaGU32Eo2PYR3cq/PM5HhIqgns="

    # docker password
    - secure: "WOvXPmJMLdtgUdCw96qn78erQ35ggcVh7OJ6pzhdoOt8vCufROgnGqGMDlQYRoIL1MnFFo5zoaaw09kOi92WiL7w2Q0QcFBQ3VkJR4Q3ooH3A/Vk0mlmGD3RXQHNzOA8Af+jK/vMxt3VVS/CUvIOI4pPWvettiazVE/KCaPDODVyT7P11iHXXO5BvufJ/BGs5g/m5q97M8xPF3GPbObCWZ6BvATIX1vfbPdiPXLzMwfzI0UrfApSaxZwVzNgr3LwOdIVaFoI68wI1QWIsR6RmIbB+M+WDnQpmYFEC4HEO6wzFk/kaJqwUxpw68K2szdO+TpqgrCx07uP06VdZrQnmfsekmEjp6s8rDQkKu84zFd1b5ZRgvSjDeNbTFP5vJOma5DQE0X03U0295oKJacEa2H6jiLJitWrrsEG+Wvb4OHeAUUGxLKmCQnQ4R4GpSq6HH5zhmLkCJ9CUz3SPouhUFztfRbfcnln/2nxbZm84vdm0TBio0RVi5oLdCboR6obCcEpmsTYo8pcUwKSVg/0rgVINNnsIGhPFwGuoDl9q833PD4gkJxJUY45wu9k/YZJye0TijfxQYlOaTxa91AvYlxi9F3M9VYuodoaRpHN1gzUiWEnorKwwf24BmrQFy3wZeAHvlmsCDS5IHlbJYJHWP+lVd3afl6jVckZWcSHiyA="

before_install:
  # Update Docker Compose
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin

  # Update Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  - sudo apt-get update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce

  # Decrypt secret key from Django
  - openssl aes-256-cbc -K $encrypted_60c0c29d8825_key -iv $encrypted_60c0c29d8825_iv -in unbrake-api/secrets/API_DJANGO_SECRET_KEY.enc -out unbrake-api/secrets/API_DJANGO_SECRET_KEY -d

before_script:
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
  - chmod +x ./cc-test-reporter
  - ./cc-test-reporter before-build

jobs:
  include:
    - stage: "Development checkings and tests"
      name: "General git checks"
      script:
        - git diff --check || (echo 'Trailing whitespaces or conflict marks found!' && exit 1)
        - if [ -d unbrake ]; then echo 'The unbrake folder must not exist!' && (exit 1); fi

    - name: "Static analysis, tests, collect coverage and check services"
      script:
        - docker-compose up -d
        - docker-compose exec frontend npm run check_all
        - docker-compose exec api python manage.py check_all
        - docker-compose down -v

        # Collect coverage
        - mkdir coverage
        - (cd unbrake-frontend && ./../cc-test-reporter format-coverage -t lcov -o ../coverage/frontend.json -p /app/frontend src/tests/coverage/lcov.info)
        - (cd unbrake-api && ./../cc-test-reporter format-coverage -t coverage.py -o ../coverage/api.json -p /app/api)

        # Merge coverage results and upload
        - ./cc-test-reporter sum-coverage -o coverage/codeclimate.json -p 2 coverage/*.json
        - if [[ "$TRAVIS_TEST_RESULT" == 0 ]] && [ "$TRAVIS_PULL_REQUEST" != "false" ]; then ./cc-test-reporter upload-coverage -i coverage/codeclimate.json; fi

    - stage: "Prepare staging environment"
      name: "Prepare frontend image"
      script:
        - docker build unbrake-frontend/ -t unbrake/frontend:latest-staging-tmp -f unbrake-frontend/production/Dockerfile
        - docker login --username "${DOCKER_USERNAME}" --password "${DOCKER_PASSWORD}"
        - docker push unbrake/frontend:latest-staging-tmp
        - docker logout

    - name: "Prepare API image"
      script:
        - docker build unbrake-api/ -t unbrake/api:latest-staging-tmp -f unbrake-api/production/Dockerfile.api
        - docker login --username "${DOCKER_USERNAME}" --password "${DOCKER_PASSWORD}"
        - docker push unbrake/api:latest-staging-tmp
        - docker logout
